<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Player</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; }
    iframe { width:100%; height:100%; border:0; display:block; }
    .error {
      position:fixed; inset:0;
      padding:16px;
      font-family:Arial, system-ui, -apple-system, Segoe UI, Roboto;
      font-size:14px; line-height:1.6;
      color:#9bd0ff; background:#000;
    }
    a{ color:#9bd0ff; }
  </style>
</head>
<body>
  <iframe id="ytFrame" allow="autoplay; encrypted-media; fullscreen; picture-in-picture" allowfullscreen></iframe>
  <div class="error" id="err" style="display:none;"></div>

<script>
  function getInt(v, d=0) {
    const n = parseInt(v ?? "", 10);
    return Number.isFinite(n) ? n : d;
  }

  function extractIdFromUrl(urlStr) {
    try {
      const u = new URL(urlStr);
      if (u.hostname.includes("youtu.be")) {
        const id = u.pathname.split("/").filter(Boolean)[0];
        return id || null;
      }
      const v = u.searchParams.get("v");
      if (v) return v;

      const shorts = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/);
      if (shorts) return shorts[1];

      const embed = u.pathname.match(/\/embed\/([a-zA-Z0-9_-]{11})/);
      if (embed) return embed[1];

      return null;
    } catch {
      return null;
    }
  }

  const frame = document.getElementById("ytFrame");
  const errEl = document.getElementById("err");

  const params = new URLSearchParams(location.search);

  // ✅ 새 방식 (추천)
  let videoId = params.get("v");

  // ✅ 예전 방식1: ?url=https://...
  const urlParam = params.get("url");
  if (!videoId && urlParam) {
    videoId = extractIdFromUrl(urlParam);
  }

  // ✅ 예전 방식2: ?https://youtu.be/... (키=값 없이 붙는 형식)
  if (!videoId) {
    const raw = location.search.startsWith("?") ? location.search.slice(1) : "";
    if (raw.startsWith("http")) {
      // raw 예: https://youtu.be/xxx&rel=0^0^0
      const onlyUrl = raw.split("&")[0]; // 첫번째 & 전까지만 URL로 취급
      videoId = extractIdFromUrl(onlyUrl);
    }
  }

  // start/end/rel 파싱 (없으면 0)
  const start = Math.max(0, getInt(params.get("start"), 0));
  const end = Math.max(0, getInt(params.get("end"), 0));
  let rel = params.get("rel") ?? "0";

  // ✅ 예전 rel=0^0^0 같은 값이면 0만 사용
  if (typeof rel === "string" && rel.includes("^")) rel = rel.split("^")[0];
  rel = (rel === "1") ? "1" : "0";

  // 검증
  if (!videoId || !/^[a-zA-Z0-9_-]{11}$/.test(videoId)) {
    errEl.style.display = "block";
    errEl.innerHTML =
      "영상 ID를 읽지 못했습니다.<br><br>" +
      "✅ 새 주소 형식(추천):<br>" +
      "<b>/youp.html?v=영상ID&start=0&end=0&rel=0</b><br><br>" +
      "✅ 예전 주소도 지원됨:<br>" +
      "<b>/youp.html?https://youtu.be/영상ID</b>";
    throw new Error("Invalid video id");
  }

  const safeEnd = (end > start) ? end : 0;

  const embedParams = new URLSearchParams({
    autoplay: "1",
    mute: "1",
    playsinline: "1",
    rel: rel,
    start: String(start)
  });
  if (safeEnd) embedParams.set("end", String(safeEnd));

  frame.src = `https://www.youtube.com/embed/${videoId}?${embedParams.toString()}`;
</script>
</body>
</html>
