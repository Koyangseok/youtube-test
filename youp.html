<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Player</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; }
    #playerWrap { width:100%; height:100%; }
    .error {
      position:fixed; inset:0;
      padding:16px;
      font-family:Arial, system-ui, -apple-system, Segoe UI, Roboto;
      font-size:14px; line-height:1.6;
      color:#9bd0ff; background:#000;
    }
    a{ color:#9bd0ff; }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto;
      font-size: 13px;
      display:none;
      z-index: 9999;
      user-select:none;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div id="playerWrap"></div>
  <div class="error" id="err" style="display:none;"></div>
  <div class="toast" id="toast"></div>

<script>
(() => {
  "use strict";

  // =========================
  // helpers
  // =========================
  const errEl = document.getElementById("err");
  const toastEl = document.getElementById("toast");

  function toast(msg, ms=1400) {
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.style.display = "none", ms);
  }

  function getInt(v, d=0) {
    const n = parseInt(v ?? "", 10);
    return Number.isFinite(n) ? n : d;
  }

  function extractIdFromUrl(urlStr) {
    try {
      const u = new URL(urlStr);

      // youtu.be/ID
      if (u.hostname.includes("youtu.be")) {
        const id = u.pathname.split("/").filter(Boolean)[0];
        return id || null;
      }

      // watch?v=ID
      const v = u.searchParams.get("v");
      if (v) return v;

      // /shorts/ID
      const shorts = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/);
      if (shorts) return shorts[1];

      // /embed/ID
      const embed = u.pathname.match(/\/embed\/([a-zA-Z0-9_-]{11})/);
      if (embed) return embed[1];

      return null;
    } catch {
      return null;
    }
  }

  function postToParent(payload) {
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage(payload, "*");
      }
    } catch {}
  }

  // =========================
  // params parse
  // =========================
  const params = new URLSearchParams(location.search);

  let videoId = params.get("v");

  // ?url=https://youtu.be/... 지원
  const urlParam = params.get("url");
  if (!videoId && urlParam) {
    videoId = extractIdFromUrl(urlParam);
  }

  // 예전 방식: ?https://youtu.be/ID
  if (!videoId) {
    const raw = location.search.startsWith("?") ? location.search.slice(1) : "";
    if (raw.startsWith("http")) {
      const onlyUrl = raw.split("&")[0];
      videoId = extractIdFromUrl(onlyUrl);
    }
  }

  const start = Math.max(0, getInt(params.get("start"), 0));
  const end = Math.max(0, getInt(params.get("end"), 0));
  let rel = params.get("rel") ?? "0";

  if (typeof rel === "string" && rel.includes("^")) rel = rel.split("^")[0];
  rel = (rel === "1") ? "1" : "0";

  const resumeEnabled = (params.get("resume") ?? "1") !== "0";

  if (!videoId || !/^[a-zA-Z0-9_-]{11}$/.test(videoId)) {
    errEl.style.display = "block";
    errEl.innerHTML =
      "영상 ID를 읽지 못했습니다.<br><br>" +
      "✅ 새 주소 형식(추천):<br>" +
      "<b>/youp.html?v=영상ID&start=0&end=0&rel=0</b><br><br>" +
      "✅ 예전 주소도 지원됨:<br>" +
      "<b>/youp.html?https://youtu.be/영상ID</b>";
    throw new Error("Invalid video id");
  }

  const safeEnd = (end > start) ? end : 0;

  // =========================
  // ✅ 이어보기 저장/복원
  // =========================
  const STORAGE_KEY = `YT_RESUME_${videoId}`;

  function loadResumeTime() {
    if (!resumeEnabled) return 0;
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return 0;
      const obj = JSON.parse(raw);
      const t = Number(obj?.t ?? 0);
      if (!Number.isFinite(t) || t < 0) return 0;
      return t;
    } catch {
      return 0;
    }
  }

  let lastSavedSec = 0;

  function saveResumeTime(seconds) {
    if (!resumeEnabled) return;

    const t = Math.floor(Number(seconds));
    if (!Number.isFinite(t) || t < 0) return;

    // 너무 초반 값은 저장 안함
    if (t < 2) return;
    if (Math.abs(t - lastSavedSec) < 1) return;
    lastSavedSec = t;

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ t, ts: Date.now() }));
    } catch {}

    // ✅ 부모(content.js)로 현재 시간 전송
    postToParent({
      type: "GYS_TIME",
      videoId,
      time: t
    });
  }

  function clearResumeTime() {
    try { localStorage.removeItem(STORAGE_KEY); } catch {}
  }

  let resumeTime = loadResumeTime();

  // end 구간이면 이어보기 초기화
  if (safeEnd && resumeTime >= safeEnd - 1) {
    resumeTime = 0;
    clearResumeTime();
  }

  // 실제 시작점 결정
  let initialStart = start;
  if (resumeEnabled && resumeTime > start + 1) {
    initialStart = resumeTime;
  }

  // =========================
  // ✅ YouTube IFrame API
  // =========================
  const tag = document.createElement("script");
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);

  let player = null;
  let saveTimer = null;

  // =========================
  // ✅ 백그라운드 유지 시도
  // =========================
  let isPageHidden = false;
  let wasPlayingBeforeHide = false;
  let backgroundKeepAliveTimer = null;

  function startBackgroundKeepAlive() {
    stopBackgroundKeepAlive();

    backgroundKeepAliveTimer = setInterval(() => {
      try {
        if (!player || !player.getPlayerState) return;

        const state = player.getPlayerState();

        // 일시정지면 재생 시도
        if (state === YT.PlayerState.PAUSED) {
          player.playVideo();
        }

        // 재생 중이면 시간 저장
        if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) {
          saveResumeTime(player.getCurrentTime());
        }
      } catch {}
    }, 1000);
  }

  function stopBackgroundKeepAlive() {
    if (backgroundKeepAliveTimer) {
      clearInterval(backgroundKeepAliveTimer);
      backgroundKeepAliveTimer = null;
    }
  }

  document.addEventListener("visibilitychange", () => {
    isPageHidden = document.hidden;

    if (isPageHidden) {
      try {
        if (player && player.getPlayerState) {
          const state = player.getPlayerState();
          wasPlayingBeforeHide = (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING);

          // 현재 시간 저장
          saveResumeTime(player.getCurrentTime());

          // 백그라운드에서도 재생 유지 시도
          if (wasPlayingBeforeHide) {
            startBackgroundKeepAlive();
          }
        }
      } catch {}
    } else {
      stopBackgroundKeepAlive();

      try {
        if (player && wasPlayingBeforeHide) {
          const state = player.getPlayerState();
          if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.CUED) {
            player.playVideo();
          }
        }
      } catch {}
    }
  });

  window.addEventListener("pagehide", () => {
    try { if (player) saveResumeTime(player.getCurrentTime()); } catch {}
  });

  window.addEventListener("beforeunload", () => {
    try { if (player) saveResumeTime(player.getCurrentTime()); } catch {}
  });

  // =========================
  // ✅ API Ready
  // =========================
  window.onYouTubeIframeAPIReady = function () {
    player = new YT.Player("playerWrap", {
      width: "100%",
      height: "100%",
      videoId: videoId,
      playerVars: {
        autoplay: 1,
        playsinline: 1,
        rel: rel,
        start: Math.floor(initialStart),
        controls: 1,
        disablekb: 0,
        fs: 1,
        modestbranding: 1,
        vq: 'hd1080',  // ✅ 화질 강제 (hd2160, hd1440, hd1080, hd720 등)
        ...(safeEnd ? { end: Math.floor(safeEnd) } : {}),
      },
      events: {
        onReady,
        onStateChange,
        onError,
      },
    });
  };

  function onReady() {
    // ✅ 최고화질 설정 (여러 방법 시도)
    function setMaxQuality() {
      try {
        const available = player.getAvailableQualityLevels();
        if (available && available.length > 0) {
          // 사용 가능한 최고 화질 (배열 첫 번째)
          player.setPlaybackQuality(available[0]);
          
          // 추가로 명시적 설정
          if (available.includes('hd2160')) {
            player.setPlaybackQuality('hd2160'); // 4K
          } else if (available.includes('hd1440')) {
            player.setPlaybackQuality('hd1440'); // 1440p
          } else if (available.includes('hd1080')) {
            player.setPlaybackQuality('hd1080'); // 1080p
          } else if (available.includes('hd720')) {
            player.setPlaybackQuality('hd720'); // 720p
          }
        }
      } catch {}
    }

    // 즉시 설정
    setMaxQuality();
    
    // 0.5초 후 재설정 (버퍼링 후)
    setTimeout(setMaxQuality, 500);
    
    // 2초 후 재설정 (재생 시작 후)
    setTimeout(setMaxQuality, 2000);

    // ✅ 1.5초마다 시간 저장 + 화질 유지
    saveTimer = setInterval(() => {
      try {
        if (!player) return;
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED || state === YT.PlayerState.BUFFERING) {
          saveResumeTime(player.getCurrentTime());
          
          // 화질이 자동으로 떨어지면 다시 최고화질로
          const current = player.getPlaybackQuality();
          const available = player.getAvailableQualityLevels();
          if (available && available.length > 0 && current !== available[0]) {
            player.setPlaybackQuality(available[0]);
          }
        }
      } catch {}
    }, 1500);
  }

  
  // =========================
  // ✅ 종료 후 추천영상 랜덤 자동재생 (Mix)
  // =========================
  function playRandomFromMix() {
    try {
      if (!player || !videoId) return;

      // "RD+현재영상ID" = 유튜브가 자동 생성하는 추천 믹스
      const mixId = "RD" + videoId;

      // 믹스 로드
      player.loadPlaylist({ listType: "playlist", list: mixId });

      // 실제 리스트가 생성될 시간을 조금 준 뒤 랜덤 선택
      setTimeout(() => {
        try {
          const list = (player.getPlaylist && player.getPlaylist()) || [];
          if (list && list.length > 1) {
            let idx = Math.floor(Math.random() * list.length);

            // 0번이 원본일 가능성이 있어 피하고 싶으면 1번부터
            if (idx === 0) idx = 1;

            player.playVideoAt(idx);
          } else {
            // fallback: 다음 영상
            if (player.nextVideo) player.nextVideo();
          }
        } catch {}
      }, 700);
    } catch {}
  }

  function onStateChange(e) {
    try {
      if (e.data === YT.PlayerState.PLAYING || e.data === YT.PlayerState.BUFFERING) {
        wasPlayingBeforeHide = true;
        
        // ✅ 재생 시작 시 최고화질로 재설정
        setTimeout(() => {
          try {
            const available = player.getAvailableQualityLevels();
            if (available && available.length > 0) {
              player.setPlaybackQuality(available[0]);
            }
          } catch {}
        }, 100);
      }

      if (e.data === YT.PlayerState.ENDED) {
        clearResumeTime();
        wasPlayingBeforeHide = false;

        // ✅ 끝나면 추천영상 중 랜덤 1개 자동재생
        playRandomFromMix();
      }

      if (e.data === YT.PlayerState.PAUSED) {
        saveResumeTime(player.getCurrentTime());

        // 백그라운드에서 갑자기 멈췄으면 재생 시도
        if (isPageHidden && wasPlayingBeforeHide) {
          setTimeout(() => {
            try {
              if (player && player.getPlayerState() === YT.PlayerState.PAUSED) {
                player.playVideo();
              }
            } catch {}
          }, 120);
        }
      }
    } catch {}
  }

  function onError(e) {
    // ✅ 임베드 재생 불가 -> 부모(content.js)로 즉시 알림 (폴백 트리거)
    postToParent({
      type: "GYS_EMBED_ERROR",
      videoId: videoId,
      code: e?.data ?? "unknown",
    });

    errEl.style.display = "block";
    errEl.innerHTML =
      "이 영상은 임베드로 재생이 제한되었거나 오류가 발생했습니다.<br><br>" +
      "YouTube 오류 코드: <b>" + (e?.data ?? "unknown") + "</b><br><br>" +
      "원본 플레이어로 자동 복귀합니다.";
  }

  // =========================
  // 오디오 컨텍스트 유지 시도(일부 브라우저)
  // =========================
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (AudioContext) {
      const audioCtx = new AudioContext();
      document.addEventListener("click", () => {
        if (audioCtx.state === "suspended") audioCtx.resume();
      }, { once: true });
    }
  } catch {}

})();
</script>
</body>
</html>
