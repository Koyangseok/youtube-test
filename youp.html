<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Player</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; }
    #playerWrap { width:100%; height:100%; }
    .error {
      position:fixed; inset:0;
      padding:16px;
      font-family:Arial, system-ui, -apple-system, Segoe UI, Roboto;
      font-size:14px; line-height:1.6;
      color:#9bd0ff; background:#000;
    }
    a{ color:#9bd0ff; }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto;
      font-size: 13px;
      display:none;
      z-index: 9999;
      user-select:none;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div id="playerWrap"></div>
  <div class="error" id="err" style="display:none;"></div>
  <div class="toast" id="toast"></div>

<script>
  function getInt(v, d=0) {
    const n = parseInt(v ?? "", 10);
    return Number.isFinite(n) ? n : d;
  }

  function extractIdFromUrl(urlStr) {
    try {
      const u = new URL(urlStr);
      if (u.hostname.includes("youtu.be")) {
        const id = u.pathname.split("/").filter(Boolean)[0];
        return id || null;
      }
      const v = u.searchParams.get("v");
      if (v) return v;

      const shorts = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/);
      if (shorts) return shorts[1];

      const embed = u.pathname.match(/\/embed\/([a-zA-Z0-9_-]{11})/);
      if (embed) return embed[1];

      return null;
    } catch {
      return null;
    }
  }

  const errEl = document.getElementById("err");
  const toastEl = document.getElementById("toast");

  function toast(msg, ms=1500) {
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.style.display = "none", ms);
  }

  const params = new URLSearchParams(location.search);

  // âœ… ìƒˆ ë°©ì‹ (ì¶”ì²œ)
  let videoId = params.get("v");

  // âœ… ì˜ˆì „ ë°©ì‹1: ?url=https://...
  const urlParam = params.get("url");
  if (!videoId && urlParam) {
    videoId = extractIdFromUrl(urlParam);
  }

  // âœ… ì˜ˆì „ ë°©ì‹2: ?https://youtu.be/... (í‚¤=ê°’ ì—†ì´ ë¶™ëŠ” í˜•ì‹)
  if (!videoId) {
    const raw = location.search.startsWith("?") ? location.search.slice(1) : "";
    if (raw.startsWith("http")) {
      const onlyUrl = raw.split("&")[0];
      videoId = extractIdFromUrl(onlyUrl);
    }
  }

  // start/end/rel íŒŒì‹±
  const start = Math.max(0, getInt(params.get("start"), 0));
  const end = Math.max(0, getInt(params.get("end"), 0));
  let rel = params.get("rel") ?? "0";

  if (typeof rel === "string" && rel.includes("^")) rel = rel.split("^")[0];
  rel = (rel === "1") ? "1" : "0";

  // âœ… ì´ì–´ë³´ê¸° ì˜µì…˜ (ê¸°ë³¸ ON)
  // resume=0 ì„ ì£¼ë©´ ì´ì–´ë³´ê¸° ë”
  const resumeEnabled = (params.get("resume") ?? "1") !== "0";

  // âœ… (ì˜µì…˜) ìµœì´ˆ ìŒì†Œê±° íŒŒë¼ë¯¸í„° ì§€ì›: mute=1 â†’ ì‹œì‘ë¶€í„° ë¬´ìŒ
  // (content.js postMessageê°€ ì£¼ë¡œ ì œì–´í•˜ì§€ë§Œ, ì•ˆì „ì¥ì¹˜ë¡œ ë‘ )
  const initialMuteParam = (params.get("mute") ?? "0") === "1";

  // ê²€ì¦
  if (!videoId || !/^[a-zA-Z0-9_-]{11}$/.test(videoId)) {
    errEl.style.display = "block";
    errEl.innerHTML =
      "ì˜ìƒ IDë¥¼ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><br>" +
      "âœ… ìƒˆ ì£¼ì†Œ í˜•ì‹(ì¶”ì²œ):<br>" +
      "<b>/youp.html?v=ì˜ìƒID&start=0&end=0&rel=0</b><br><br>" +
      "âœ… ì˜ˆì „ ì£¼ì†Œë„ ì§€ì›ë¨:<br>" +
      "<b>/youp.html?https://youtu.be/ì˜ìƒID</b>";
    throw new Error("Invalid video id");
  }

  const safeEnd = (end > start) ? end : 0;

  // =========================
  // âœ… ì´ì–´ë³´ê¸° ì €ì¥/ë³µì› ë¡œì§
  // =========================
  const STORAGE_KEY = `YT_RESUME_${videoId}`;

  function loadResumeTime() {
    if (!resumeEnabled) return 0;
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return 0;
      const obj = JSON.parse(raw);

      const t = Number(obj?.t ?? 0);
      if (!Number.isFinite(t) || t < 0) return 0;

      return t;
    } catch {
      return 0;
    }
  }

  function saveResumeTime(seconds) {
    if (!resumeEnabled) return;
    const t = Number(seconds);
    if (!Number.isFinite(t) || t < 0) return;
    if (t < 2) return;

    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ t: t, ts: Date.now() }));
    } catch {}
  }

  function clearResumeTime() {
    try { localStorage.removeItem(STORAGE_KEY); } catch {}
  }

  let resumeTime = loadResumeTime();

  if (safeEnd && resumeTime >= safeEnd - 1) {
    resumeTime = 0;
    clearResumeTime();
  }

  let initialStart = start;
  if (resumeEnabled && resumeTime > start + 1) {
    initialStart = resumeTime;
  }

  // =========================
  // âœ… ì™¸ë¶€(content.js)ì—ì„œ ë³´ë‚´ëŠ” mute/unmute ë©”ì‹œì§€ ì²˜ë¦¬
  // =========================
  let player = null;

  // í˜„ì¬ ì›í•˜ëŠ” ìŒì†Œê±° ìƒíƒœ(í”Œë ˆì´ì–´ ìƒì„± ì „ì—ë„ ë°›ì„ ìˆ˜ ìˆê²Œ ì €ì¥)
  let desiredMuted = initialMuteParam;

  function applyMuteState() {
    try {
      if (!player) return;
      if (desiredMuted) player.mute();
      else player.unMute();
    } catch {}
  }

  window.addEventListener("message", (event) => {
    const data = event?.data;
    if (!data || data.source !== "GYS") return;

    if (data.type === "SET_MUTE") {
      desiredMuted = !!data.muted;
      applyMuteState();

      // ë””ë²„ê·¸ í† ìŠ¤íŠ¸ (ì›í•˜ë©´ ì£¼ì„ì²˜ë¦¬)
      // toast(desiredMuted ? "ğŸ”‡ ìŒì†Œê±°" : "ğŸ”Š ìŒì†Œê±° í•´ì œ", 800);
    }
  });

  // =========================
  // âœ… YouTube IFrame API ë¡œë“œ
  // =========================
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);

  let saveTimer = null;
  let didSeekResume = false;

  // APIê°€ ì¤€ë¹„ë˜ë©´ ìë™ í˜¸ì¶œë¨
  window.onYouTubeIframeAPIReady = function () {
    player = new YT.Player('playerWrap', {
      width: '100%',
      height: '100%',
      videoId: videoId,
      playerVars: {
        autoplay: 1,
        playsinline: 1,
        rel: rel,
        start: Math.floor(initialStart),
        ...(safeEnd ? { end: Math.floor(safeEnd) } : {}),
      },
      events: {
        onReady: onReady,
        onStateChange: onStateChange,
        onError: onError
      }
    });
  };

  function onReady() {
    // âœ… í”Œë ˆì´ì–´ ì¤€ë¹„ë˜ë©´, ì›í•˜ëŠ” mute ìƒíƒœ ì ìš©
    applyMuteState();

    // startê°€ ë¬´ì‹œë˜ëŠ” í™˜ê²½ ë³´ì •
    if (resumeEnabled && !didSeekResume && initialStart > 0) {
      try {
        player.seekTo(initialStart, true);
        didSeekResume = true;
        toast(`ì´ì–´ë³´ê¸°: ${Math.floor(initialStart)}ì´ˆë¶€í„° ì¬ìƒ`);
      } catch {}
    }

    // 4ì´ˆë§ˆë‹¤ í˜„ì¬ì‹œê°„ ì €ì¥
    saveTimer = setInterval(() => {
      try {
        if (!player) return;
        const state = player.getPlayerState();
        if (state === 1 || state === 2 || state === 3) {
          const t = player.getCurrentTime();
          saveResumeTime(t);
        }
      } catch {}
    }, 4000);

    // íƒ­ ìˆ¨ê¹€/ì¢…ë£Œ ì‹œ í•œë²ˆ ë” ì €ì¥
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        try { saveResumeTime(player.getCurrentTime()); } catch {}
      }
    });

    window.addEventListener("beforeunload", () => {
      try { saveResumeTime(player.getCurrentTime()); } catch {}
    });
  }

  function onStateChange(e) {
    try {
      // âœ… ìƒíƒœ ë³€ë™ ë•Œ muteê°€ í’€ë¦¬ëŠ” ê²½ìš°ê°€ ìˆì–´ì„œ í•œ ë²ˆ ë” ë³´ì •
      applyMuteState();

      if (e.data === YT.PlayerState.ENDED) {
        clearResumeTime();
      }
      if (e.data === YT.PlayerState.PAUSED) {
        saveResumeTime(player.getCurrentTime());
      }
    } catch {}
  }

  function onError(e) {
    errEl.style.display = "block";
    errEl.innerHTML =
      "ì´ ì˜ìƒì€ ì„ë² ë“œë¡œ ì¬ìƒì´ ì œí•œë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br><br>" +
      "YouTube ì˜¤ë¥˜ ì½”ë“œ: <b>" + (e?.data ?? "unknown") + "</b><br><br>" +
      "ê°€ëŠ¥í•˜ë©´ ì›ë³¸ YouTube í˜ì´ì§€ì—ì„œ ì¬ìƒí•´ì•¼ í•©ë‹ˆë‹¤.";
  }
</script>
</body>
</html>
